---
---
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>External Polis Authentication with Auth0</title>
    <link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon">
    <style>
      .hidden {
        display: none;
      }

      label {
        margin-bottom: 10px;
        display: block;
      }
    </style>
  </head>

  <body>
    <h2>External Polis Authentication with Auth0</h2>

    <button id="btn-login" disabled="true" onclick="login()">Log in</button>
    <button id="btn-logout" disabled="true" onclick="logout()">Log out</button>

    <div class="hidden" id="gated-content">
      <p>
        You're seeing this content because you're currently
        <strong>logged in</strong>.
      </p>
      <label>
        User profile:
        <pre id="ipt-user-profile"></pre>
      </label>
      <label>
        Polis Conversation:
        <div id="polis-container"></div>
      </label>
    </div>

    <script src="https://cdn.auth0.com/js/auth0-spa-js/1.13/auth0-spa-js.production.js"></script>
    <script>
      let auth0 = null;
      const fetchAuthConfig = () => fetch("./auth_config.json");
      const configureClient = async () => {
        const response = await fetchAuthConfig();
        const config = await response.json();

        auth0 = await createAuth0Client({
          domain: config.domain,
          client_id: config.clientId,
          redirect_uri: "{{ site.url }}{{ site.baseurl }}{{ page.url }}",
        });
      };

      const updateUI = async () => {
        const isAuthenticated = await auth0.isAuthenticated();

        document.getElementById("btn-logout").disabled = !isAuthenticated;
        document.getElementById("btn-login").disabled = isAuthenticated;

        if (isAuthenticated) {
          const auth0User = await auth0.getUser();
          document.getElementById("gated-content").classList.remove("hidden");
          document.getElementById("ipt-user-profile").textContent = JSON.stringify(auth0User);
          attachPolis(auth0User.sub, auth0User.name, auth0User.picture);
        } else {
          document.getElementById("gated-content").classList.add("hidden");
        }
      };


      const login = async () => {
        const redirectUri = "{{ site.url }}{{ site.baseurl }}{{ page.url }}";
        await auth0.loginWithRedirect({
          redirect_uri: redirectUri,
        });
      };

      const logout = () => {
        const redirectUri = "{{ site.url }}{{ site.baseurl }}{{ page.url }}";
        auth0.logout({
          returnTo: redirectUri,
        });
      };

      const POLIS_CONVO_ID = '43hmhaj9vm';
      const POLIS_SERVER_URL = 'https://pol.is';
      function attachPolis (xid, userName, userAvatar) {
        let polisContainer = document.getElementById('polis-container');
        let polisHtml = `<div
          class="polis"
          data-conversation_id="${POLIS_CONVO_ID}"
          data-xid="${xid}"
          data-x_name="${userName}"
          data-x_profile_image_url="${userAvatar}"
        ></div>`

        let embedScript = document.createElement('script');
        embedScript.src = POLIS_SERVER_URL + '/embed.js';
        embedScript.type = 'text/javascript';
        embedScript.async = true;

        polisContainer.innerHTML = polisHtml;
        polisContainer.appendChild(embedScript);
      }

      window.onload = async () => {
        await configureClient();
        updateUI();

        const isAuthenticated = await auth0.isAuthenticated();

        if (isAuthenticated) {
          return;
        }

        const query = window.location.search;
        if (query.includes("code=") && query.includes("state=")) {
          await auth0.handleRedirectCallback();
          updateUI();
          window.history.replaceState({}, document.title, "{{ page.url }}");
        }
      }
    </script>
  </body>
</html>
